<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Publishing Script of this Website</title>
<meta name="description" content="Using org-mode to write a publishing script as a literate program" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<title>andersch.dev</title>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" href="/style.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Ubuntu:regular,bold&subset=Latin"><script type="text/javascript" src="/script.js" defer></script>
</head>
<body>
<header id="top" class="status">
<header>
<h1 class="title" id="title"><a href="/">andersch.dev</a></h1>

<div class="icons">
  	<a id="icon-github" href="https://github.com/dandersch" ><span>dandersch</span><img src="/icons/github.svg"></a>
  	<a id="icon-feed"   href="https://andersch.dev/feed.xml" target="_blank"><img src="/icons/rss.svg"><span></span></a>
  	<a id="icon-mail"   href="mailto:contact [at} andersch {dot) dev"  ><img src="/icons/mail.svg"><span>contact [at} andersch {dot) dev</span></a>
</div>
<div>
	<nav class="nav">
		<a class="nav-link" href="/article">article</a>
		<a class="nav-link" href="/project">project</a>
		<a class="nav-link" href="/other">other</a>
		<a class="nav-link" href="/notes">wiki</a>
	</nav>
</div>
</header>
</header>
<main id="content" class="content">
<div class="tags-date-box"><div class="date"><span class="timestamp"><2024-06-02></span></div><div class="tags"><code>[ <a href="/tag/lisp.html">lisp</a> <a href="/tag/org.html">org</a> <a href="/tag/web.html">web</a> ]</code></div></div><h1>The Publishing Script of this Website</h1><h2 class="subtitle">Using org-mode to write a publishing script as a literate program</h1>
<div class="figure">
  <img src="/other/publish/preview.png" alt="">
</div>
<p>
This page is the HTML exported version of the script that generates this
website. The script is written in <code>emacs-lisp</code>, but is using org-mode to write it
out as a <a href="https://en.wikipedia.org/wiki/Literate_programming">literate program</a>. When generating, all emacs-lisp source code that you
see on this page is <a href="https://orgmode.org/manual/Extracting-Source-Code.html">tangled</a> from the <a href="http:./index.org">original org-file</a> to a file called
<a href="../../publish.el"><code>publish.el</code></a>.
</p>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgfd9a16d">1. Package Archives</a></li>
<li><a href="#org7449998">2. Dependencies</a></li>
<li><a href="#orga4488b9">3. Configuration</a></li>
<li><a href="#org8825acf">4. Helper functions</a></li>
<li><a href="#org159c157">5. Filter out links to <code>index.html</code></a></li>
<li><a href="#org6c46018">6. Comment Section</a>
<ul>
<li><a href="#orga7e17e3">6.1. Loading animation script</a></li>
<li><a href="#org5112469">6.2. HTML Layout</a></li>
<li><a href="#org353fa7c">6.3. Elisp variable</a></li>
</ul>
</li>
<li><a href="#org01e69ed">7. Footnotes Section workaround</a></li>
<li><a href="#orgc0e6ae3">8. <span class="todo TODO">TODO</span> Keyword Lists</a></li>
<li><a href="#org16684f5">9. RSS Feed Generation</a></li>
<li><a href="#org854cd8b">10. Tagging System</a></li>
<li><a href="#org72b5bf2">11. Prepare publishing function</a></li>
<li><a href="#org33cdba5">12. Custom Export Function</a></li>
<li><a href="#orgf219e9c">13. Filter: Insert Header</a></li>
<li><a href="#org98d6768">14. Org-publish Customization</a>
<ul>
<li><a href="#org838da9c">14.1. Project: <code>andersch.dev</code></a></li>
<li><a href="#org76101f0">14.2. Project: <code>roam.andersch.dev</code></a></li>
<li><a href="#orgfdfe220">14.3. Add projects to <code>org-publish-project-alist</code></a></li>
</ul>
</li>
<li><a href="#orge9c65e4">15. org-publish</a></li>
<li><a href="#org765334d">16. Code snippets</a>
<ul>
<li><a href="#org64fbf9a">16.1. Generate Article Image Preview</a></li>
<li><a href="#orgdda29e3">16.2. Generate Article Snippets</a></li>
</ul>
</li>
<li><a href="#org316d4b5">17. Resources</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgfd9a16d" class="outline-2">
<h2 id="orgfd9a16d"><span class="section-number-2">1.</span> <a href="#orgfd9a16d">Package Archives</a></h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">set package install dir to local directory</span>
(<span class="org-keyword">require</span> '<span class="org-constant">package</span>)
(<span class="org-keyword">setq</span> package-user-dir (expand-file-name <span class="org-string">"./.packages"</span>))
(<span class="org-keyword">setq</span> package-archives '((<span class="org-string">"melpa"</span> . <span class="org-string">"https://melpa.org/packages/"</span>)
                         (<span class="org-string">"elpa"</span> . <span class="org-string">"https://elpa.gnu.org/packages/"</span>)
                         (<span class="org-string">"nongnu"</span> . <span class="org-string">"https://elpa.nongnu.org/nongnu/"</span>)))
(package-initialize)
(<span class="org-keyword">unless</span> package-archive-contents (package-refresh-contents))
</pre>
</div>
</div>
</div>
<div id="outline-container-org7449998" class="outline-2">
<h2 id="org7449998"><span class="section-number-2">2.</span> <a href="#org7449998">Dependencies</a></h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(package-install 'htmlize) <span class="org-comment-delimiter">; </span><span class="org-comment">enable export of #+begin_src code blocks</span>
(package-install 'glsl-mode) <span class="org-comment-delimiter">; </span><span class="org-comment">for coloring glsl src blocks</span>
(<span class="org-keyword">require</span> '<span class="org-constant">glsl-mode</span>)

(<span class="org-keyword">require</span> '<span class="org-constant">ox-publish</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">org</span>)

(<span class="org-keyword">require</span> '<span class="org-constant">cl-lib</span>)

<span class="org-comment-delimiter">; </span><span class="org-comment">for :IGNORE: headlines</span>
(package-install 'org-contrib) <span class="org-comment-delimiter">; </span><span class="org-comment">for ox-extra</span>
(<span class="org-keyword">require</span> '<span class="org-constant">ox-extra</span>)
(ox-extras-activate '(latex-header-blocks ignore-headlines))

(<span class="org-keyword">require</span> '<span class="org-constant">ob-emacs-lisp</span>)

<span class="org-comment-delimiter">; </span><span class="org-comment">NOTE: not needed for exporting roam notes (?)</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">(package-install 'org-roam)</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">(require 'org-roam)</span>

(add-to-list 'load-path <span class="org-string">"~/dev/org-slide"</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">org-slide</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orga4488b9" class="outline-2">
<h2 id="orga4488b9"><span class="section-number-2">3.</span> <a href="#orga4488b9">Configuration</a></h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span>
      keywords '(<span class="org-string">"TITLE"</span> <span class="org-string">"DATE"</span> <span class="org-string">"DESCRIPTION"</span> <span class="org-string">"IMAGE"</span> <span class="org-string">"TAGS[]"</span> <span class="org-string">"FILETAGS"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">keywords to parse from .org files</span>
      org-html-htmlize-output-type 'css
      org-export-allow-bind-keywords t <span class="org-comment-delimiter">; </span><span class="org-comment">Allows #+BIND: in a buffer</span>
      org-confirm-babel-evaluate nil   <span class="org-comment-delimiter">; </span><span class="org-comment">needed to enable org-babel src-block execution from a script</span>
      org-src-fontify-natively t)

<span class="org-comment-delimiter">; </span><span class="org-comment">set footnotes to be h3, everything else is default</span>
(<span class="org-keyword">setq</span> org-html-footnotes-section
      <span class="org-string">"&lt;div id=\"footnotes\"&gt;\n&lt;h3 class=\"footnotes\"&gt;%s&lt;/h3&gt;\n&lt;div id=\"text-footnotes\"&gt;\n%s\n&lt;/div&gt;\n&lt;/div&gt;"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org8825acf" class="outline-2">
<h2 id="org8825acf"><span class="section-number-2">4.</span> <a href="#org8825acf">Helper functions</a></h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">get-org-files</span> (directory)
  <span class="org-doc">"Return a list of .org files in DIRECTORY excluding '</span><span class="org-doc"><span class="org-constant">index.org</span></span><span class="org-doc">'."</span>
  (cl-remove-if
   (<span class="org-keyword">lambda</span> (file) (string-equal (concat directory <span class="org-string">"/"</span> <span class="org-string">"index.org"</span>) file))
   (directory-files-recursively directory <span class="org-string">"\\.org$"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">get-org-file-keywords</span> (file)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert-file-contents file)
    (list file (org-collect-keywords keywords))))

(<span class="org-keyword">defun</span> <span class="org-function-name">sort-keyword-list-by-date</span> (keyword-list <span class="org-type">&amp;optional</span> new-to-old)
  <span class="org-doc">"Sort the list by the date value of the form &lt;YYYY-MM-DD HH:MM&gt;"</span>
  (sort keyword-list
        (<span class="org-keyword">lambda</span> (a b)
          (<span class="org-keyword">let*</span> ((date-str-a (replace-regexp-in-string <span class="org-string">"&lt;\\[</span><span class="org-string"><span class="org-constant">\\</span></span><span class="org-string">]&gt;"</span> <span class="org-string">""</span> (cadr (assoc <span class="org-string">"DATE"</span> (cadr a)))))
                 (date-str-b (replace-regexp-in-string <span class="org-string">"&lt;\\[</span><span class="org-string"><span class="org-constant">\\</span></span><span class="org-string">]&gt;"</span> <span class="org-string">""</span> (cadr (assoc <span class="org-string">"DATE"</span> (cadr b))))))
            (<span class="org-keyword">if</span> new-to-old
              (string&gt; date-str-a date-str-b)
              (string&lt; date-str-a date-str-b))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">article-marked-for-noexport-p</span> (article)
  (string-match-p (regexp-quote <span class="org-string">"noexport"</span>) (cadr (assoc <span class="org-string">"TAGS[]"</span> (cadr article)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">roam-note-marked-for-noexport-p</span> (article)
  (string-match-p (regexp-quote <span class="org-string">"noexport"</span>) (cadr (assoc <span class="org-string">"FILETAGS"</span> (cadr article)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org159c157" class="outline-2">
<h2 id="org159c157"><span class="section-number-2">5.</span> <a href="#org159c157">Filter out links to <code>index.html</code></a></h2>
<div class="outline-text-2" id="text-5">
<p>
Replace links to e.g. <code>"article/index.html"</code> to just <code>"article"</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">filter-out-index-html</span> (transcoded-data-string backend communication-channel-plist)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    <span class="org-comment-delimiter">; </span><span class="org-comment">NOTE "/index.html" doesn't get replaced in case of internal links for some reason...</span>
    (string-replace <span class="org-string">"index.html"</span> <span class="org-string">""</span>
                    (string-replace <span class="org-string">"/index.html"</span> <span class="org-string">""</span> (substring-no-properties transcoded-data-string)))))

(add-to-list 'org-export-filter-link-functions 'filter-out-index-html)
</pre>
</div>
</div>
</div>
<div id="outline-container-org6c46018" class="outline-2">
<h2 id="org6c46018"><span class="section-number-2">6.</span> <a href="#org6c46018">Comment Section</a></h2>
<div class="outline-text-2" id="text-6">
<p>
Adds a GitHub Issues-based comment section using <a href="https://utteranc.es/">utterances</a>. Only applies to
articles that are marked with the keyword <code>#+COMMENTS: t</code>.
</p>
</div>
<div id="outline-container-orga7e17e3" class="outline-3">
<h3 id="orga7e17e3"><span class="section-number-3">6.1.</span> <a href="#orga7e17e3">Loading animation script</a></h3>
<div class="outline-text-3" id="text-6-1">
<p>
Following javascript animates the comment section title until the lazy-loaded
comment section has loaded in.
</p>

<div class="org-src-container">
<pre class="src src-js" id="comment-loading-animation-js"><span class="org-keyword">const</span> <span class="org-variable-name">commentSectionTitle</span> = document.getElementById(<span class="org-string">'comment-section-title'</span>);
<span class="org-keyword">const</span> <span class="org-variable-name">commentsDiv</span>         = document.getElementById(<span class="org-string">'comment-section'</span>);
commentSectionTitle.style.animation = <span class="org-string">'loading 0.6s infinite alternate'</span>;
document.addEventListener(<span class="org-string">'DOMContentLoaded'</span>, <span class="org-keyword">function</span>() {
  <span class="org-keyword">const</span> <span class="org-variable-name">observer</span> = <span class="org-keyword">new</span> <span class="org-type">MutationObserver</span>(<span class="org-keyword">function</span>(<span class="org-variable-name">mutationsList</span>) {
    <span class="org-keyword">for</span> (<span class="org-keyword">let</span> <span class="org-variable-name">mutation</span> <span class="org-keyword">of</span> mutationsList) {
      <span class="org-keyword">if</span> (mutation.type === <span class="org-string">'childList'</span>) {
        <span class="org-keyword">for</span> (<span class="org-keyword">let</span> <span class="org-variable-name">node</span> <span class="org-keyword">of</span> mutation.addedNodes) {
          <span class="org-keyword">if</span> (node.nodeName === <span class="org-string">'DIV'</span>) {
            <span class="org-keyword">for</span> (<span class="org-keyword">const</span> <span class="org-variable-name">child</span> <span class="org-keyword">of</span> node.children) {
              <span class="org-keyword">if</span> (child.tagName === <span class="org-string">'IFRAME'</span>) {
                child.addEventListener(<span class="org-string">'load'</span>, <span class="org-keyword">function</span>() {
                  commentSectionTitle.style.animation = <span class="org-string">'none'</span>;
                });
              }
            }
          }
        }
      }
    }
  });

  observer.observe(commentsDiv, { childList: <span class="org-constant">true</span> });
});
</pre>
</div>
</div>
</div>
<div id="outline-container-org5112469" class="outline-3">
<h3 id="org5112469"><span class="section-number-3">6.2.</span> <a href="#org5112469">HTML Layout</a></h3>
<div class="outline-text-3" id="text-6-2">
<p>
Note the usage of single quotes instead of double quotes for attribute values.
This way we can use noweb to include the html without having to escape strings.
</p>

<div class="org-src-container">
<pre class="src src-html" id="comment-section-html">&lt;<span class="org-function-name">hr</span>&gt;
&lt;<span class="org-function-name">div</span> <span class="org-variable-name">id</span>=<span class="org-string">'comment-section'</span>&gt;
&lt;<span class="org-function-name">h3</span> <span class="org-variable-name">id</span>=<span class="org-string">'comment-section-title'</span>&gt;<span class="org-underline"><span class="org-italic">Comments</span></span>&lt;/<span class="org-function-name">h3</span>&gt;
&lt;<span class="org-function-name">script</span> <span class="org-variable-name">src</span>=<span class="org-string">'https://utteranc.es/client.js'</span>
       <span class="org-variable-name">repo</span>=<span class="org-string">'dandersch/andersch.dev'</span>
       <span class="org-variable-name">issue-term</span>=<span class="org-string">'pathname'</span>
       <span class="org-variable-name">label</span>=<span class="org-string">'.&#128172;'</span>
       <span class="org-variable-name">theme</span>=<span class="org-string">'photon-dark'</span>
       <span class="org-variable-name">crossorigin</span>=<span class="org-string">'anonymous'</span>
       async&gt;
&lt;/<span class="org-function-name">script</span>&gt;
&lt;<span class="org-function-name">script</span> <span class="org-variable-name">type</span>=<span class="org-string">'text/javascript'</span>&gt;
&lt;&lt;<span class="org-function-name">comment-loading-animation-js</span>&gt;&gt;
&lt;/<span class="org-function-name">script</span>&gt;
&lt;/<span class="org-function-name">div</span>&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-org353fa7c" class="outline-3">
<h3 id="org353fa7c"><span class="section-number-3">6.3.</span> <a href="#org353fa7c">Elisp variable</a></h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> comment-section-html <span class="org-string">"&lt;&lt;comment-section-html&gt;&gt;"</span> )
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org01e69ed" class="outline-2">
<h2 id="org01e69ed"><span class="section-number-2">7.</span> <a href="#org01e69ed">Footnotes Section workaround</a></h2>
<div class="outline-text-2" id="text-7">
<p>
If we include above HTML at the very end of an org-file using <code>#+BEGIN_EXPORT
html</code>, org-mode will still append the footnotes section below that (if the
article ever used <code>[fn::footnote text]</code>). As a workaround, we define below
function to later add as a filter-hook to insert the HTML at the very end.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">; </span><span class="org-comment">needed because otherwise footnotes will be below the comment section</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">insert-comment-section</span>  (contents html-backend info)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"&lt;/main&gt;"</span> contents)
    (replace-match (concat comment-section-html <span class="org-string">"&lt;/main&gt;"</span>) t t contents 0)))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc0e6ae3" class="outline-2">
<h2 id="orgc0e6ae3"><span class="section-number-2">8.</span> <a href="#orgc0e6ae3"><span class="todo TODO">TODO</span> Keyword Lists</a></h2>
<div class="outline-text-2" id="text-8">
<p>
Fills the primary datastructure of this script of the form:
</p>

<p>
<code>("article.org" (("TITLE" "Article Title") ("TAGS" "tag1 tag2")))</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">; </span><span class="org-comment">TODO put together to a single keyword-list</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">(setq keyword-list</span>
<span class="org-comment-delimiter">;  </span><span class="org-comment">'(</span>
<span class="org-comment-delimiter">;     </span><span class="org-comment">("article" '("article.org" (("TITLE" "Article Title") ("TAGS" "tag1 tag2"))))</span>
<span class="org-comment-delimiter">;     </span><span class="org-comment">("project" '("project1.org" (("TITLE" "Article Title") ("TAGS" "tag1 tag2")))</span>
<span class="org-comment-delimiter">;   </span><span class="org-comment">)</span>
(<span class="org-keyword">setq</span> article-keyword-list '())
(<span class="org-keyword">setq</span> project-keyword-list '())
(<span class="org-keyword">setq</span> other-keyword-list   '())
(<span class="org-keyword">setq</span> notes-keyword-list   '())

<span class="org-comment-delimiter">; </span><span class="org-comment">usage:</span>
<span class="org-comment-delimiter">;   </span><span class="org-comment">(cadr (assoc "TITLE" (cadr (assoc "article" article)))</span>

<span class="org-comment-delimiter">; </span><span class="org-comment">NOTE workaround to pass keyword-list to a source-block in an org file</span>
<span class="org-comment-delimiter">;      </span><span class="org-comment">(else "Symbol&#8217;s function definition is void" error when publishing)</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">get-article-keyword-list</span> () article-keyword-list)
(<span class="org-keyword">defun</span> <span class="org-function-name">get-project-keyword-list</span> () project-keyword-list)
(<span class="org-keyword">defun</span> <span class="org-function-name">get-other-keyword-list</span>   () other-keyword-list)
(<span class="org-keyword">defun</span> <span class="org-function-name">get-notes-keyword-list</span>   () notes-keyword-list)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">; </span><span class="org-comment">fill &amp; sort keyword-lists for project/, article/, other/</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">fill-keyword-lists</span> ()
  (<span class="org-keyword">dolist</span> (article (get-org-files <span class="org-string">"article"</span>))
    (<span class="org-keyword">let</span> ((article-keywords (get-org-file-keywords article)))
      (<span class="org-keyword">unless</span> (article-marked-for-noexport-p article-keywords)
        (<span class="org-keyword">push</span> (get-org-file-keywords article) article-keyword-list))))
  (<span class="org-keyword">setq</span> article-keyword-list (sort-keyword-list-by-date article-keyword-list t))

  (<span class="org-keyword">dolist</span> (project (get-org-files <span class="org-string">"project"</span>))
    (<span class="org-keyword">let</span> ((project-keywords (get-org-file-keywords project)))
      (<span class="org-keyword">unless</span> (article-marked-for-noexport-p project-keywords)
        (<span class="org-keyword">push</span> (get-org-file-keywords project) project-keyword-list))))
  (<span class="org-keyword">setq</span> project-keyword-list (sort-keyword-list-by-date project-keyword-list t))

  (<span class="org-keyword">dolist</span> (other (get-org-files <span class="org-string">"other"</span>))
    (<span class="org-keyword">let</span> ((other-keywords (get-org-file-keywords other)))
      (<span class="org-keyword">unless</span> (article-marked-for-noexport-p other-keywords)
        (<span class="org-keyword">push</span> (get-org-file-keywords other) other-keyword-list))))
  (<span class="org-keyword">setq</span> other-keyword-list (sort-keyword-list-by-date other-keyword-list t))

  <span class="org-comment-delimiter">; </span><span class="org-comment">article-keyword-list == (cdr (assoc "article" keyword-list))</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">(setq keyword-list `(,(cons "article" article-keyword-list)</span>
  <span class="org-comment-delimiter">;                     </span><span class="org-comment">,(cons "project" project-keyword-list)</span>
  <span class="org-comment-delimiter">;                     </span><span class="org-comment">,(cons "other"   other-keyword-list))))</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">TODO append</span>
  (<span class="org-keyword">setq</span> keyword-list '())
  (<span class="org-keyword">setq</span> keyword-list (append keyword-list
                           `((<span class="org-string">"article"</span> . ,article-keyword-list)
                             (<span class="org-string">"project"</span> . ,project-keyword-list)
                             (<span class="org-string">"other"</span>   . ,other-keyword-list)))))

<span class="org-comment-delimiter">; </span><span class="org-comment">fill &amp; sort keyword-lists for notes/ (called by roam project)</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">roam-fill-keyword-lists</span> ()
  (<span class="org-keyword">dolist</span> (note (get-org-files org-roam-directory))
    (<span class="org-keyword">let</span> ((notes-keywords (get-org-file-keywords note)))
      (<span class="org-keyword">unless</span> (roam-note-marked-for-noexport-p notes-keywords)
        (<span class="org-keyword">push</span> (get-org-file-keywords note) notes-keyword-list))))
  <span class="org-comment-delimiter">;</span><span class="org-comment">(setq notes-keyword-list (sort-keyword-list-by-date notes-keyword-list t)) ; NOTE: no date prop...</span>

  <span class="org-comment-delimiter">; </span><span class="org-comment">article-keyword-list == (cdr (assoc "article" keyword-list))</span>
  (<span class="org-keyword">setq</span> keyword-list `(,(cons <span class="org-string">"notes"</span> notes-keyword-list)))
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-org16684f5" class="outline-2">
<h2 id="org16684f5"><span class="section-number-2">9.</span> <a href="#org16684f5">RSS Feed Generation</a></h2>
<div class="outline-text-2" id="text-9">
<p>
Generates a simple rss feed for articles specifically.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">generate-main-rss-feed</span> ()
  <span class="org-comment-delimiter">; </span><span class="org-comment">rss header, check with  https://validator.w3.org/feed/</span>
  (<span class="org-keyword">with-temp-file</span> <span class="org-string">"feed.xml"</span>
    (insert
     (<span class="org-keyword">let*</span> ((website-title <span class="org-string">"andersch.dev"</span>)
            (homepage      <span class="org-string">"https://andersch.dev"</span>)
            (rss-filepath  <span class="org-string">"/feed.xml"</span>))
     (concat <span class="org-string">"&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n"</span>
             <span class="org-string">"&lt;rss version=\"2.0\" xmlns:atom=\"http://www.w3.org/2005/Atom\"&gt;\n"</span>
             <span class="org-string">"&lt;channel&gt;\n"</span>
             (format <span class="org-string">"&lt;title&gt;%s&lt;/title&gt;\n"</span> website-title)
             <span class="org-string">"&lt;!-- &lt;lastBuildDate&gt;Wed, 15 Dec 2021 00:00:00 +0000&lt;/lastBuildDate&gt; --&gt;\n"</span> <span class="org-comment-delimiter">; </span><span class="org-comment">TODO insert todays date</span>
             (format <span class="org-string">"&lt;atom:link href=\"%s%s\" rel=\"self\" type=\"application/rss+xml\"/&gt;\n"</span> homepage rss-filepath)
             (format <span class="org-string">"&lt;link&gt;%s&lt;/link&gt;\n"</span> homepage)
             <span class="org-string">"&lt;description&gt;Stuff on programming&lt;/description&gt;\n"</span>
             <span class="org-string">"&lt;language&gt;en-us&lt;/language&gt;\n"</span>))))
  <span class="org-comment-delimiter">; </span><span class="org-comment">rss entries</span>
  (<span class="org-keyword">dolist</span> (article article-keyword-list)
    (write-region
      (format
         (concat <span class="org-string">"&lt;item&gt;\n"</span>
                 <span class="org-string">"&lt;title&gt;%s&lt;/title&gt;\n"</span>
                 <span class="org-string">"&lt;link&gt;%s&lt;/link&gt;\n"</span>
                 <span class="org-string">"&lt;guid&gt;%s&lt;/guid&gt;\n"</span>
                 <span class="org-string">"&lt;description&gt;\n"</span>
                 <span class="org-string">"&amp;lt;p&amp;gt;%s&amp;lt;/p&amp;gt;\n"</span>
                 <span class="org-string">"&amp;lt;img src=\"https://andersch.dev/%s\"/&amp;gt;\n"</span>
                 <span class="org-string">"&lt;/description&gt;\n"</span>
                 <span class="org-string">"&lt;pubDate&gt;%s&lt;/pubDate&gt;\n&lt;/item&gt;\n"</span>)
            (cadr (assoc <span class="org-string">"TITLE"</span> (cadr article)))
            (concat <span class="org-string">"https://andersch.dev/"</span> (string-replace <span class="org-string">"/index.org"</span> <span class="org-string">""</span> (car article)))
            (concat <span class="org-string">"https://andersch.dev/"</span> (string-replace <span class="org-string">"/index.org"</span> <span class="org-string">""</span> (car article)))
            (cadr (assoc <span class="org-string">"DESCRIPTION"</span> (cadr article)))
            (concat (string-replace <span class="org-string">"index.org"</span> <span class="org-string">""</span> (car article)) (cadr (assoc <span class="org-string">"IMAGE"</span> (cadr article))))
            (format-time-string <span class="org-string">"%a, %d %b %Y %H:%M:%S %z"</span> (seconds-to-time (org-time-string-to-time (cadr (assoc <span class="org-string">"DATE"</span> (cadr article))))))
            )
      nil <span class="org-string">"feed.xml"</span> 'append))
  <span class="org-comment-delimiter">; </span><span class="org-comment">rss ending</span>
  (write-region <span class="org-string">"&lt;/channel&gt;\n&lt;/rss&gt;"</span> nil <span class="org-string">"feed.xml"</span> 'append))
</pre>
</div>
</div>
</div>
<div id="outline-container-org854cd8b" class="outline-2">
<h2 id="org854cd8b"><span class="section-number-2">10.</span> <a href="#org854cd8b">Tagging System</a></h2>
<div class="outline-text-2" id="text-10">
<p>
Generates a <code>tag.org</code> for every unique tag across all articles.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">generate-tag-files</span> ()

  <span class="org-comment-delimiter">; </span><span class="org-comment">collect all tags</span>
  (<span class="org-keyword">setq</span> article-tags '())
  (<span class="org-keyword">dolist</span> (article article-keyword-list)
     (<span class="org-keyword">setq</span> article-tags (append (split-string (cadr (assoc <span class="org-string">"TAGS[]"</span> (cadr article)))  <span class="org-string">" +"</span>) article-tags)))
  (delete-dups article-tags)

  (<span class="org-keyword">setq</span> project-tags '())
  (<span class="org-keyword">dolist</span> (project project-keyword-list)
     (<span class="org-keyword">setq</span> project-tags (append (split-string (cadr (assoc <span class="org-string">"TAGS[]"</span> (cadr project)))  <span class="org-string">" +"</span>) project-tags)))
  (delete-dups project-tags)

  (<span class="org-keyword">setq</span> other-tags '())
  (<span class="org-keyword">dolist</span> (other other-keyword-list)
     <span class="org-comment-delimiter">;</span><span class="org-comment">(print other) ; ("other/publish/index.org" (("TITLE" "The Script ") ("DESCRIPTION" "...") ("DATE" "&lt;..&gt;") ("IMAGE" "preview.png") ("TAGS[]" "lisp org web")))</span>
     (<span class="org-keyword">setq</span> other-tags (append (split-string (cadr (assoc <span class="org-string">"TAGS[]"</span> (cadr other)))  <span class="org-string">" +"</span>) other-tags)))
  (delete-dups other-tags)

  (<span class="org-keyword">setq</span> notes-tags '())
  (<span class="org-keyword">dolist</span> (notes notes-keyword-list)
     (<span class="org-keyword">setq</span> notes-tags (cl-remove-if #'string-empty-p (append (split-string (cadr (assoc <span class="org-string">"FILETAGS"</span> (cadr notes)))  <span class="org-string">":"</span>) notes-tags))))
  (delete-dups notes-tags)

  (<span class="org-keyword">setq</span> all-tags '())
  (<span class="org-keyword">setq</span> all-tags (cl-concatenate 'list article-tags project-tags other-tags notes-tags))
  (delete-dups all-tags)

  <span class="org-comment-delimiter">; </span><span class="org-comment">generate .org files for all tags</span>
  (<span class="org-keyword">dolist</span> (tag all-tags)
    (<span class="org-keyword">with-temp-file</span> (format <span class="org-string">"tag/%s.org"</span> tag)
      (insert (format <span class="org-string">"#+TITLE: Pages tagged %s\n"</span> tag))))

  <span class="org-comment-delimiter">; </span><span class="org-comment">append "* Articles" headline</span>
  (<span class="org-keyword">dolist</span> (tag article-tags)
    (write-region (format <span class="org-string">"* Articles tagged ~%s~\n"</span> tag) nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append))
  <span class="org-comment-delimiter">; </span><span class="org-comment">add entry of an article to its tag.org's</span>
  (<span class="org-keyword">dolist</span> (article article-keyword-list)
    (<span class="org-keyword">dolist</span> (tag (split-string (cadr (assoc <span class="org-string">"TAGS[]"</span> (cadr article)))  <span class="org-string">" +"</span>))
      (write-region (format <span class="org-string">"- [[../%s][%s]]\n"</span> (car article) (cadr (assoc <span class="org-string">"TITLE"</span> (cadr article))))
                    nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append)))

  <span class="org-comment-delimiter">; </span><span class="org-comment">append "* Projects" headline</span>
  (<span class="org-keyword">dolist</span> (tag project-tags)
    (write-region (format <span class="org-string">"* Projects tagged ~%s~\n"</span> tag) nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append))
  <span class="org-comment-delimiter">; </span><span class="org-comment">add entry of a project to its tag.org's</span>
  (<span class="org-keyword">dolist</span> (project project-keyword-list)
    (<span class="org-keyword">dolist</span> (tag (split-string (cadr (assoc <span class="org-string">"TAGS[]"</span> (cadr project)))  <span class="org-string">" +"</span>))
      (write-region (format <span class="org-string">"- [[../%s][%s]]\n"</span> (car project) (cadr (assoc <span class="org-string">"TITLE"</span> (cadr project))))
                    nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append)))

  <span class="org-comment-delimiter">; </span><span class="org-comment">append "* Other" headline</span>
  (<span class="org-keyword">dolist</span> (tag other-tags)
    (write-region (format <span class="org-string">"* Other tagged ~%s~\n"</span> tag) nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append))
  <span class="org-comment-delimiter">; </span><span class="org-comment">add entry of other to its tag.org's</span>
  (<span class="org-keyword">dolist</span> (other other-keyword-list)
    (<span class="org-keyword">dolist</span> (tag (split-string (cadr (assoc <span class="org-string">"TAGS[]"</span> (cadr other)))  <span class="org-string">" +"</span>))
      (write-region (format <span class="org-string">"- [[../%s][%s]]\n"</span> (car other) (cadr (assoc <span class="org-string">"TITLE"</span> (cadr other))))
                    nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append)))

  <span class="org-comment-delimiter">; </span><span class="org-comment">append "* Notes" headline</span>
  (<span class="org-keyword">dolist</span> (tag notes-tags)
    (write-region (format <span class="org-string">"* Notes tagged ~%s~\n"</span> tag) nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append))
  <span class="org-comment-delimiter">; </span><span class="org-comment">add entry of notes to its tag.org's</span>
  (<span class="org-keyword">dolist</span> (notes notes-keyword-list)
    (<span class="org-keyword">dolist</span> (tag (cl-remove-if #'string-empty-p (split-string (cadr (assoc <span class="org-string">"FILETAGS"</span> (cadr notes)))  <span class="org-string">":"</span>)))
      <span class="org-comment-delimiter">; </span><span class="org-comment">TODO hardcoded string-replace</span>
      (write-region (format <span class="org-string">"- [[../%s][%s]]\n"</span> (string-replace <span class="org-string">"~/org/roam"</span> <span class="org-string">"notes"</span> (car notes)) (cadr (assoc <span class="org-string">"TITLE"</span> (cadr notes))))
                    nil (format <span class="org-string">"tag/%s.org"</span> tag) 'append)))
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-org72b5bf2" class="outline-2">
<h2 id="org72b5bf2"><span class="section-number-2">11.</span> <a href="#org72b5bf2">Prepare publishing function</a></h2>
<div class="outline-text-2" id="text-11">
<p>
Gets called by <code>org-publish</code> before the main publishing step.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span>  <span class="org-function-name">prepare-publishing</span> (project-properties)
  (fill-keyword-lists)
  (generate-main-rss-feed)
  (generate-tag-files))

(<span class="org-keyword">defun</span>  <span class="org-function-name">roam-prepare-publishing</span> (project-properties)
  (roam-fill-keyword-lists))
</pre>
</div>
</div>
</div>
<div id="outline-container-org33cdba5" class="outline-2">
<h2 id="org33cdba5"><span class="section-number-2">12.</span> <a href="#org33cdba5">Custom Export Function</a></h2>
<div class="outline-text-2" id="text-12">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-html-publish-to-html-noexport</span> (plist filename pub-dir)
  <span class="org-doc">"Publish an org file to HTML except one's that are tagged noexport"</span>

  <span class="org-comment-delimiter">; </span><span class="org-comment">FILENAME is the filename of the Org file to be published</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">PLIST is the property list for the given project</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">PUB-DIR is the publishing directory.</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">Return output file name</span>

  (<span class="org-keyword">let</span> ((notes-keywords (get-org-file-keywords filename)))
    (<span class="org-keyword">if</span> (roam-note-marked-for-noexport-p notes-keywords)
        nil
      (org-html-publish-to-html plist filename pub-dir)))
)

</pre>
</div>
</div>
</div>
<div id="outline-container-orgf219e9c" class="outline-2">
<h2 id="orgf219e9c"><span class="section-number-2">13.</span> <a href="#orgf219e9c">Filter: Insert Header</a></h2>
<div class="outline-text-2" id="text-13">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">add-title-headline</span> (backend)
  <span class="org-comment-delimiter">; </span><span class="org-comment">insert after :PROPERTY: drawer</span>
  (<span class="org-keyword">if</span> (string-match-p <span class="org-string">":PROPERTIES:"</span> (thing-at-point 'line t))
     (<span class="org-keyword">progn</span> (search-forward <span class="org-string">":END:"</span> nil t) (forward-line 1)))
  (<span class="org-keyword">when</span> (eq backend 'html)
    (<span class="org-keyword">let*</span> ((tags (<span class="org-keyword">if</span> org-file-tags org-file-tags nil))
           (date (cadar (org-collect-keywords '(<span class="org-string">"DATE"</span>))))
           (description (cadar (org-collect-keywords '(<span class="org-string">"DESCRIPTION"</span>))))
           (title (org-get-title)))
      (insert <span class="org-string">"\n#+begin_export html\n"</span>)
      (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> tags date)
        (insert <span class="org-string">"&lt;div class=\"tags-date-box\"&gt;"</span>)
          (<span class="org-keyword">if</span> date (insert (format <span class="org-string">"&lt;div class=\"date\"&gt;&lt;span class=\"timestamp\"&gt;%s&lt;/span&gt;&lt;/div&gt;"</span> date)))
          (<span class="org-keyword">when</span> tags
              (insert <span class="org-string">"&lt;div class=\"tags\"&gt;&lt;code&gt;[ "</span>)
              (<span class="org-keyword">dolist</span> (tag tags) (insert (format <span class="org-string">"&lt;a href=\"/tag/%s.html\"&gt;%s&lt;/a&gt; "</span> tag tag)))
              (insert <span class="org-string">"]&lt;/code&gt;&lt;/div&gt;"</span>))
        (insert <span class="org-string">"&lt;/div&gt;"</span>))
      (<span class="org-keyword">when</span> title (insert (format <span class="org-string">"&lt;h1&gt;%s&lt;/h1&gt;"</span> title)))
      (<span class="org-keyword">when</span> description (insert (format <span class="org-string">"&lt;h2 class=\"subtitle\"&gt;%s&lt;/h1&gt;"</span> description)))
      (insert <span class="org-string">"\n#+end_export\n"</span>)
      )
    )
  )
(add-hook 'org-export-before-processing-functions #'add-title-headline)
</pre>
</div>
</div>
</div>
<div id="outline-container-org98d6768" class="outline-2">
<h2 id="org98d6768"><span class="section-number-2">14.</span> <a href="#org98d6768">Org-publish Customization</a></h2>
<div class="outline-text-2" id="text-14">
<p>
See <a href="https://www.gnu.org/software/emacs/manual/html_node/org/Publishing-options.html">here</a> for exporter-specific properties and use <code>(describe-variable
'org-publish-project-alist)</code> for documentation on general options.
</p>
</div>
<div id="outline-container-org838da9c" class="outline-3">
<h3 id="org838da9c"><span class="section-number-3">14.1.</span> <a href="#org838da9c">Project: <code>andersch.dev</code></a></h3>
<div class="outline-text-3" id="text-14-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> andersch-dev
      (list <span class="org-string">"andersch.dev"</span>
             <span class="org-builtin">:recursive</span>            t
             <span class="org-builtin">:base-directory</span>       <span class="org-string">"./"</span>
             <span class="org-builtin">:publishing-directory</span> <span class="org-string">"./"</span>
             <span class="org-builtin">:publishing-function</span>  'org-html-publish-to-html    <span class="org-comment-delimiter">;; </span><span class="org-comment">may be a list of functions</span>
             <span class="org-builtin">:preparation-function</span> 'prepare-publishing          <span class="org-comment-delimiter">;; </span><span class="org-comment">called before publishing</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:completion-function                               ;; called afterwards</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:base-extension                                    ;; extension of source files</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:html-extension       ""                           ;; extension of generated html files (without dot)</span>
             <span class="org-builtin">:exclude</span>  (regexp-opt '(<span class="org-string">"code.org"</span> <span class="org-string">"README.org"</span> <span class="org-string">"publish.org"</span>)) <span class="org-comment-delimiter">;; </span><span class="org-comment">regex of files to exclude</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:include                                           ;; list of files to include</span>

           <span class="org-comment-delimiter">; </span><span class="org-comment">:html-doctype "html5"                              ;; default is "xhtml-strict"</span>
             <span class="org-builtin">:html-divs</span>            '((preamble <span class="org-string">"header"</span> <span class="org-string">"top"</span>)
                                     (content <span class="org-string">"main"</span> <span class="org-string">"content"</span>)
                                     (postamble <span class="org-string">"footer"</span> <span class="org-string">"postamble"</span>))
             <span class="org-builtin">:html-html5-fancy</span>     t
             <span class="org-comment-delimiter">; </span><span class="org-comment">TODO head defined else where and noweb it here</span>
             <span class="org-builtin">:html-head</span>            (concat <span class="org-string">"&lt;title&gt;andersch.dev&lt;/title&gt;\n"</span>
                                           <span class="org-string">"&lt;link rel=\"icon\" type=\"image/x-icon\" href=\"/favicon.ico\"&gt;\n"</span>
                                           <span class="org-string">"&lt;link rel=\"stylesheet\" href=\"/style.css\"&gt;\n"</span>
                                           <span class="org-comment-delimiter">; </span><span class="org-comment">NOTE import ubuntu font for now TODO embed in repo</span>
                                           <span class="org-string">"&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://fonts.googleapis.com/css?family=Ubuntu:regular,bold&amp;subset=Latin\"&gt;"</span>
                                           <span class="org-string">"&lt;script type=\"text/javascript\" src=\"/script.js\" defer&gt;&lt;/script&gt;"</span>
                                           )
             <span class="org-builtin">:html-preamble</span>        t
             <span class="org-builtin">:html-preamble-format</span> `((<span class="org-string">"en"</span> ,(<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"header.html"</span>) (buffer-string))))
             <span class="org-builtin">:html-postamble</span>       nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't insert a footer with a date etc.</span>

             <span class="org-builtin">:html-link-home</span>                  <span class="org-string">""</span>
             <span class="org-builtin">:html-head-include-default-style</span> t
             <span class="org-builtin">:html-self-link-headlines</span>   t <span class="org-comment-delimiter">; </span><span class="org-comment">headings contain hyperlinks to themselves</span>

             <span class="org-builtin">:auto-sitemap</span>         nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">https://orgmode.org/manual/Site-map.html</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:sitemap-filename     "sitemap.org"</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:sitemap-title</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:sitemap-style        'tree                     ;; list or tree</span>
           <span class="org-comment-delimiter">; </span><span class="org-comment">:sitemap-sort-files   'anti-chronologically</span>
             <span class="org-builtin">:exclude-tags</span>         org-export-exclude-tags
             <span class="org-builtin">:html-prefer-user-labels</span>  t                     <span class="org-comment-delimiter">;; </span><span class="org-comment">prefer CUSTOM_ID over auto-generated id's</span>

             <span class="org-builtin">:html-format-headline-function</span> org-html-format-headline-function
                                               <span class="org-comment-delimiter">; </span><span class="org-comment">function will be called with six arguments:</span>
                                               <span class="org-comment-delimiter">; </span><span class="org-comment">TODO      the todo keyword (string or nil).</span>
                                               <span class="org-comment-delimiter">; </span><span class="org-comment">TODO-TYPE the type of todo (symbol: todo, done, nil)</span>
                                               <span class="org-comment-delimiter">; </span><span class="org-comment">PRIORITY  the priority of the headline (integer or nil)</span>
                                               <span class="org-comment-delimiter">; </span><span class="org-comment">TEXT      the main headline text (string).</span>
                                               <span class="org-comment-delimiter">; </span><span class="org-comment">TAGS      the tags (string or nil).</span>
                                               <span class="org-comment-delimiter">; </span><span class="org-comment">INFO      the export options (plist).</span>

             <span class="org-builtin">:makeindex</span>            nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">https://orgmode.org/manual/Generating-an-index.html</span>
             <span class="org-builtin">:with-title</span>           nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">we include our own header</span>
             <span class="org-builtin">:with-tags</span>            nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">* headline :tag:</span>
             <span class="org-builtin">:with-author</span>          nil
             <span class="org-builtin">:with-creator</span>         nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't include emacs and org versions in footer</span>
             <span class="org-builtin">:with-toc</span>             nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">no table of contents</span>
             <span class="org-builtin">:section-numbers</span>      nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">no section numbers for headings</span>
             <span class="org-builtin">:html-validation-link</span> nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't show validation link</span>
             <span class="org-builtin">:time-stamp-file</span>      nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't include "Created: &lt;timestamp&gt;" in footer</span>
             <span class="org-builtin">:with-date</span>            nil))
</pre>
</div>
</div>
</div>
<div id="outline-container-org76101f0" class="outline-3">
<h3 id="org76101f0"><span class="section-number-3">14.2.</span> <a href="#org76101f0">Project: <code>roam.andersch.dev</code></a></h3>
<div class="outline-text-3" id="text-14-2">
<p>
Wiki portion of the site as a separate project.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-roam-directory <span class="org-string">"~/org/roam"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">NOTE not part of the repo</span>

(<span class="org-keyword">setq</span> roam-andersch-dev-images
      (list <span class="org-string">"roam.andersch.dev-images"</span>
             <span class="org-builtin">:base-directory</span> org-roam-directory
             <span class="org-builtin">:base-extension</span> <span class="org-string">"jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">gif</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">svg"</span>
             <span class="org-builtin">:publishing-directory</span> <span class="org-string">"./notes/"</span>
             <span class="org-builtin">:publishing-function</span> 'org-publish-attachment))

(<span class="org-keyword">setq</span> roam-andersch-dev
      (list <span class="org-string">"roam.andersch.dev"</span>
             <span class="org-builtin">:recursive</span>            nil
             <span class="org-builtin">:base-directory</span>       org-roam-directory
             <span class="org-builtin">:publishing-directory</span> <span class="org-string">"./notes/"</span>
             <span class="org-builtin">:publishing-function</span>  'org-html-publish-to-html-noexport
             <span class="org-builtin">:preparation-function</span> 'roam-prepare-publishing
             <span class="org-builtin">:html-divs</span>            '((preamble <span class="org-string">"header"</span> <span class="org-string">"top"</span>)
                                     (content <span class="org-string">"main"</span> <span class="org-string">"content"</span>)
                                     (postamble <span class="org-string">"footer"</span> <span class="org-string">"postamble"</span>))
             <span class="org-builtin">:html-html5-fancy</span>     t
             <span class="org-comment-delimiter">; </span><span class="org-comment">TODO head defined else where and noweb it here</span>
             <span class="org-builtin">:html-head</span>            (concat <span class="org-string">"&lt;title&gt;andersch.dev&lt;/title&gt;\n"</span>
                                           <span class="org-string">"&lt;link rel=\"icon\" type=\"image/x-icon\" href=\"/favicon.ico\"&gt;\n"</span>
                                           <span class="org-string">"&lt;link rel=\"stylesheet\" href=\"/style.css\"&gt;\n"</span>
                                           <span class="org-comment-delimiter">; </span><span class="org-comment">NOTE import ubuntu font for now TODO embed in repo</span>
                                           <span class="org-string">"&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://fonts.googleapis.com/css?family=Ubuntu:regular,bold&amp;subset=Latin\"&gt;"</span>
                                           <span class="org-string">"&lt;script type=\"text/javascript\" src=\"/script.js\" defer&gt;&lt;/script&gt;"</span>
                                           )

             <span class="org-builtin">:exclude-tags</span>             org-export-exclude-tags
             <span class="org-builtin">:html-self-link-headlines</span> t   <span class="org-comment-delimiter">;; </span><span class="org-comment">headings contain hyperlinks to themselves</span>
             <span class="org-builtin">:html-prefer-user-labels</span>  t   <span class="org-comment-delimiter">;; </span><span class="org-comment">prefer CUSTOM_ID over auto-generated id's</span>

             <span class="org-builtin">:html-preamble</span>        t
             <span class="org-builtin">:html-preamble-format</span> `((<span class="org-string">"en"</span> ,(<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"header.html"</span>) (buffer-string))))
             <span class="org-builtin">:html-postamble</span>       nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't insert a footer with a date etc.</span>
             <span class="org-builtin">:auto-sitemap</span>         nil
             <span class="org-builtin">:makeindex</span>            nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">https://orgmode.org/manual/Generating-an-index.html</span>
             <span class="org-builtin">:with-title</span>           nil
             <span class="org-builtin">:with-author</span>          nil
             <span class="org-builtin">:with-creator</span>         nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't include emacs and org versions in footer</span>
             <span class="org-builtin">:with-toc</span>             nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">no table of contents</span>
             <span class="org-builtin">:section-numbers</span>      nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">no section numbers for headings</span>
             <span class="org-builtin">:html-validation-link</span> nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't show validation link</span>
             <span class="org-builtin">:time-stamp-file</span>      nil                       <span class="org-comment-delimiter">;; </span><span class="org-comment">don't include "Created: &lt;timestamp&gt;" in footer</span>
             <span class="org-builtin">:with-date</span>            nil))

<span class="org-comment-delimiter">;; </span><span class="org-comment">TODO roam-andersch-dev-attachment</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfdfe220" class="outline-3">
<h3 id="orgfdfe220"><span class="section-number-3">14.3.</span> <a href="#orgfdfe220">Add projects to <code>org-publish-project-alist</code></a></h3>
<div class="outline-text-3" id="text-14-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-publish-project-alist (list andersch-dev roam-andersch-dev-images roam-andersch-dev))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge9c65e4" class="outline-2">
<h2 id="orge9c65e4"><span class="section-number-2">15.</span> <a href="#orge9c65e4">org-publish</a></h2>
<div class="outline-text-2" id="text-15">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">; </span><span class="org-comment">caching</span>
(<span class="org-keyword">setq</span> org-publish-timestamp-directory <span class="org-string">"./.org-timestamps/"</span>)
<span class="org-comment-delimiter">;</span><span class="org-comment">(org-publish-remove-all-timestamps) ; call to avoid caching</span>

(<span class="org-keyword">setq</span> org-id-locations-file <span class="org-string">"/home/da/org/.orgids"</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">should fix broken links</span>
(<span class="org-keyword">setq</span> org-export-with-broken-links nil) <span class="org-comment-delimiter">; </span><span class="org-comment">NOTE might be needed for broken roam ID links...</span>

<span class="org-comment-delimiter">; </span><span class="org-comment">enable caching for roam.andersch.dev</span>
(org-publish-initialize-cache <span class="org-string">"roam.andersch.dev"</span>)
(<span class="org-keyword">setq</span> org-publish-use-timestamps-flag t)

(org-publish <span class="org-string">"roam.andersch.dev-images"</span>)
(org-publish <span class="org-string">"roam.andersch.dev"</span>)
(message <span class="org-string">"Build complete: roam.andersch.dev"</span>)

<span class="org-comment-delimiter">; </span><span class="org-comment">NOTE caching causes problems with updating titles etc., so we reset the cache before publishing</span>
(<span class="org-keyword">setq</span> org-publish-use-timestamps-flag nil)
(org-publish <span class="org-string">"andersch.dev"</span> t)
(message <span class="org-string">"Build complete: andersch.dev"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org765334d" class="outline-2">
<h2 id="org765334d"><span class="section-number-2">16.</span> <a href="#org765334d">Code snippets</a></h2>
<div class="outline-text-2" id="text-16">
</div>
<div id="outline-container-org64fbf9a" class="outline-3">
<h3 id="org64fbf9a"><span class="section-number-3">16.1.</span> <a href="#org64fbf9a">Generate Article Image Preview</a></h3>
<div class="outline-text-3" id="text-16-1">
<p>
TODO only used to generate preview image, move to filter function
</p>
</div>
</div>
<div id="outline-container-orgdda29e3" class="outline-3">
<h3 id="orgdda29e3"><span class="section-number-3">16.2.</span> <a href="#orgdda29e3">Generate Article Snippets</a></h3>
</div>
</div>
<div id="outline-container-org316d4b5" class="outline-2">
<h2 id="org316d4b5"><span class="section-number-2">17.</span> <a href="#org316d4b5">Resources</a></h2>
<div class="outline-text-2" id="text-17">
<ul class="org-ul">
<li><a href="https://pank.eu/blog/blog-setup.html">Blogging with Org</a></li>
<li><a href="https://ogbe.net/blog/blogging_with_org">Blogging using org-mode (and nothing else)</a></li>
</ul>
</div>
</div>
</main>
</body>
</html>
